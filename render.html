<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>graphics</title>
</head>
<style>
    body, html {
      height: 100%;
      margin: 0;
      display: grid;
      place-items: center;
    }

    canvas {
      border: 1px solid black; /* Optional, for visual reference */
    }
  </style>
<div>
    <button id="loadForest"> load forest </button>
    <button id="loadCube"> load cube </button>
</div>
<body>
    <canvas id="myCanvas" repetition="no-repeat"></canvas>
    <script src="WASM_forestDemo.js"></script>
    <script src="render.js"></script>
    <script>
        // Wait for the Wasm module to be instantiated
        var wcPtr, ctx, imageData;
        var initialize, renderPass, getFrameBuffer, initializeFromObj, deleteWebContext;
        var rx = 0.0, ry = 0.0, rz = 0.0;
        const canvas = document.getElementById('myCanvas');
        canvas.width = 800; // Set width to 800 pixels
        canvas.height = 600;

        Module.onRuntimeInitialized = () => { 
            
            initialize = Module._initialize;
            initializeFromObj = Module._initializeFromObj;
            renderPass = Module._renderPass; 
            getFrameBuffer = Module._getFrameBuffer;
            deleteWebContext = Module._deleteWebContext;

            

            wcPtr = initialize(canvas.width, canvas.height);
            const pixelDataPtr = getFrameBuffer(wcPtr);
            const pixelData = new Uint8ClampedArray(Module.HEAPU8.buffer, pixelDataPtr, canvas.width * canvas.height * 4);
            //const canvas = document.getElementById('myCanvas');
            ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log("1:", wcPtr);
            renderPass(wcPtr, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
            imageData = new ImageData(pixelData, canvas.width, canvas.height);
            

            console.log("2:", wcPtr);
            
            ctx.putImageData(imageData, 0, 0);
            
        };

        const keyActions = {
            'ArrowUp': () => ry += 1.0,
            'ArrowDown': () => ry -= 1.0,
            'ArrowLeft': () => rz += 1.0,
            'ArrowRight': () => rz -= 1.0
        };

        document.addEventListener('keydown', (event) => {
            
            if (keyActions[event.key]) {
                keyActions[event.key]();
            }
            renderPass(wcPtr, 0.0, 0.0, 0.0, 0.0, ry, rz);
            //think of a better way to do this
            ry = 0.0; rz = 0.0;
            ctx.putImageData(imageData, 0, 0);
        });

        document.getElementById('loadForest').addEventListener('click', function() {
            deleteWebContext(wcPtr);
            wcPtr = initializeFromObj(canvas.width, canvas.height);
            renderPass(wcPtr, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
        });

    </script>
</body>
</html>